$K.infinity.pause(),function(e){e.Pillar=function(t,n){this.element=e(n);if(!this.element.length){$K.infinity.resume();return}this._init(t)},e.Pillar.settings={items:"",identifiers:{pillars:"pillar"},maxMobileWidth:767,columns:3,spacing:10,gutter:-1,balanceColumns:!0,variability:"none",variabilityAmt:0,variabilityOverride:2,maxWidthsSum:100},e.Pillar.prototype={_init:function(t){var n=this;t instanceof Object||(e.Pillar.settings.items=t),this.options=e.extend(!0,{},e.Pillar.settings,t),this.options.gutter<0&&(this.options.gutter=this.options.spacing),this._columns=[],this.options.columns instanceof Object?e.each(this.options.columns,function(e,t){var r={cols:t};e!=="max"&&(r.width=parseInt(e,10)),n._columns.push(r)}):this._columns.push({cols:1,width:parseInt(this.options.maxMobileWidth,10)},{cols:this.options.columns}),this.element.css("margin","0 "+(this.options.gutter>0?this.options.gutter/2:0)+"px"),e(window).off(".pbind").on("k-infinite-loaded.pbind",function(){n._updatePillars()}),this._createPillar(function(){n._resize()})},_createPillar:function(t){var n=e("<div/>").addClass(this.options.identifiers.pillars).css({display:"inline","float":"left"}),r=e("<div/>"),i=this._getWidthIdent(),s=this,o,u;if(e("."+this.options.identifiers.pillars+".size_"+i).length){t&&t();return}e.each(this._columns,function(e,t){o="size_"+(t.width||"max"),u=t.cols;if(t.width==i)return!1});for(var a=0,f=u;a<f;a++){var l=Math.floor(100/u*100)/100,c=function(){var e=[];if(s.options.variability==="even"||s.options.variability==="odd")for(var t=0;t<u;t++)e.push(t%2>0&&s.options.variability==="even"||t%2<=0&&s.options.variability==="odd"?l-s.options.variabilityAmt:l+s.options.variabilityAmt);else if(s.options.variability==="random")for(var t=0;t<u;t++){var n=Math.floor(Math.random()*(s.options.variabilityAmt-0+1)+0);e.push(Math.round(Math.random())==0?l-n:l+n)}var r=e.reduce(function(e,t){return e+t},0);if(r!=s.options.maxWidthsSum){var i=Math.abs((r-s.options.maxWidthsSum)/u);e=e.map(function(e){return r>s.options.maxWidthsSum?e-i:e+i})}return e};s.options.variability!=="none"&&!s.options.widths&&u>s.options.variabilityOverride&&(s.options.widths=c());var h=n.clone().width(l+"%");s.options.widths&&h.width(s.options.widths[a]+"%"),r.append(h.hide().addClass(o))}this.element.prepend(r.children()),e("."+this.options.identifiers.pillars+".size_"+i).show(),t&&t()},_updatePillars:function(){$K.infinity.pause();var t=this,n=e("> "+this.options.items,this.element);n.length<=0&&(n=e(this.options.items,this.element)),n=n.filter(function(){return!e(this).closest(".pillar").length});var r={};n.length>0&&n.each(function(n){var i=e(this);i.parent().hasClass("k-control-structure")&&i.parent().children().length===1&&(i=i.parent()),e.each(t._columns,function(s,o){var u=n%o.cols,a="size_"+(o.width||"max"),f=i.clone(!0,!0);if(e("."+t.options.identifiers.pillars+"."+a).length===0||i.attr("data-"+a))return;r["pillar_"+u+"_"+a]=r["pillar_"+u+"_"+a]||[],t._setSpacing.call(t,f,u),t.options.imageLoaded&&f.find("img").off(".pimage").on("k-image-loaded.pimage",t.options.imageLoaded),r["pillar_"+u+"_"+a].push(f),i.attr("data-"+a,!0)})}),e.each(r,function(n,r){var i=n.split("_"),s=e("."+t.options.identifiers.pillars+".size_"+i.pop()+":eq("+i[1]+")");s&&s.append(r)}),setTimeout(function(){var n=e(".pillar [data-responsive-hold]");n.attr("data-lazy-hold",!0),$K.responsiveImages(n,function(){t.options.balanceColumns?t._balancePillars.call(t):setTimeout(function(){e("[data-lazy-hold]").attr("data-lazy-hold",null),$K.infinity.resume()},0)})},0)},_balancePillars:function(){var t=this;$K.infinity.pause();var n=this._getPillarStats(),r=e(">:last-child",n.longest),i=r.outerHeight(!0);if(this.options.variability!=="none"){var s=n.shortest.width();s!=n.longest.width()&&(i=s*i/r.width())}n.difference>i?(n.shortest.append(r),this._setSpacing(r,n.shortest.index()),this.options.variability!=="none"?$K.responsiveImages(r.find("img[data-presets]"),function(){t._balancePillars.call(t)}):t._balancePillars.call(t)):setTimeout(function(){e("[data-lazy-hold]").attr("data-lazy-hold",null),$K.infinity.resume()},0)},_getPillarStats:function(){var t,n,r=[],i=0,s=0;return e("."+this.options.identifiers.pillars+".size_"+this._getWidthIdent()).each(function(){var o=e(this),u=o.outerHeight(!0);if(!n||u>i)n=o,i=u;if(!t||u<s)t=o,s=u;r.push(o)}),{pillars:r,shortest:t,longest:n,difference:i-s}},_setSpacing:function(t,n){t=t.hasClass("k-control-structure")?t.children().first():t,this.options.spacing>0&&e(t).css("margin","0px "+this.options.spacing/2+"px "+this.options.spacing+"px")},_getWidthIdent:function(){if(this._widthIdent)return this._widthIdent;var t,n=e(window).width();return e.each(this._columns,function(e,r){if(n<=r.width)return t=r.width,!1}),this._widthIdent=t||"max",this._widthIdent},_resize:function(){var t=this,n=0;e(window).on("k-resize.pbind",function(){e(window).width()!==n&&(t._widthIdent=!1,n=e(window).width(),t.options.widths=null,t._createPillar(function(){e("."+t.options.identifiers.pillars).hide(),e("."+t.options.identifiers.pillars+".size_"+t._getWidthIdent()).show(),t.options.viewportChange&&t.options.viewportChange.call(t,type),setTimeout(function(){t._updatePillars.call(t)},0)}))})}},e.fn.pillar=function(t,n){return e.data(this,"pillar",new e.Pillar(t,this)),this}}(jQuery);